import { type ReactElement, useMemo } from 'react';
import { useTranslation } from 'react-i18next';
import { Outlet } from 'react-router-dom';
import { Navbar } from './Navbar';
import { Sidebar } from './Sidebar';
import { Footer } from './Footer';
import { useUIStore } from '@/stores/ui-store';
import { cn } from '@/lib/utils';

interface NavItem {
  title: string;
  href?: string;
  icon?: ReactElement;
  children?: NavItem[];
}

interface MainLayoutProps {
  navItems?: NavItem[];
}

const normalizeForSort = (text: string): string => {
  return text
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/ı/g, 'i')
    .replace(/ş/g, 's')
    .replace(/ğ/g, 'g')
    .replace(/ü/g, 'u')
    .replace(/ö/g, 'o')
    .replace(/ç/g, 'c')
    .replace(/İ/g, 'i')
    .replace(/Ş/g, 's')
    .replace(/Ğ/g, 'g')
    .replace(/Ü/g, 'u')
    .replace(/Ö/g, 'o')
    .replace(/Ç/g, 'c');
};

export function MainLayout({ navItems }: MainLayoutProps): ReactElement {
  const { t } = useTranslation();

  const defaultNavItems: NavItem[] = useMemo(() => [
    {
      title: t('sidebar.dashboard'),
      href: '/',
      icon: (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <rect width="7" height="9" x="3" y="3" rx="1" />
          <rect width="7" height="5" x="14" y="3" rx="1" />
          <rect width="7" height="9" x="14" y="12" rx="1" />
          <rect width="7" height="5" x="3" y="16" rx="1" />
        </svg>
      ),
    },
    {
      title: t('sidebar.goodsReceipt'),
      icon: (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
          <circle cx="9" cy="7" r="4" />
          <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
          <path d="M16 3.13a4 4 0 0 1 0 7.75" />
        </svg>
      ),
      children: [
        {
          title: t('sidebar.goodsReceiptAssigned', 'Atanmış Mal Kabul Emirleri'),
          href: '/goods-receipt/assigned',
        },
        {
          title: t('sidebar.goodsReceiptCreate'),
          href: '/goods-receipt/create',
        },
        {
          title: t('sidebar.goodsReceiptList'),
          href: '/goods-receipt/list',
        },
      ].sort((a, b) => normalizeForSort(a.title).localeCompare(normalizeForSort(b.title), 'tr')),
    },
    {
      title: t('sidebar.inventory'),
      icon: (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z" />
          <path d="M3 6h18" />
          <path d="M16 10a4 4 0 0 1-8 0" />
        </svg>
      ),
      children: [
        {
          title: t('sidebar.warehouse3d', '3D Depo'),
          href: '/inventory/3d-warehouse',
        },
      ],
    },
    {
      title: t('sidebar.reports'),
      href: '/reports',
      icon: (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
          <path d="M14 2v6h6" />
          <path d="M16 13H8" />
          <path d="M16 17H8" />
          <path d="M10 9H8" />
        </svg>
      ),
    },
    {
      title: t('sidebar.package', 'Paketleme'),
      icon: (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
          <polyline points="3.27 6.96 12 12.01 20.73 6.96" />
          <line x1="12" y1="22.08" x2="12" y2="12" />
        </svg>
      ),
      children: [
        {
          title: t('sidebar.packageCreate', 'Yeni Paketleme'),
          href: '/package/create',
        },
        {
          title: t('sidebar.packageList', 'Paketleme Listesi'),
          href: '/package/list',
        },
      ].sort((a, b) => normalizeForSort(a.title).localeCompare(normalizeForSort(b.title), 'tr')),
    },
    {
      title: t('sidebar.transfer'),
      icon: (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <path d="M21 8L17 12M17 12L21 16M17 12H3M3 16L7 12M7 12L3 8" />
        </svg>
      ),
      children: [
        {
          title: t('sidebar.transferAssigned', 'Atanmış Transfer Emirleri'),
          href: '/transfer/assigned',
        },
        {
          title: t('sidebar.transferApproval', 'Onay Bekleyen Emirler'),
          href: '/transfer/approval',
        },
        {
          title: t('sidebar.transferCreate'),
          href: '/transfer/create',
        },
        {
          title: t('sidebar.transferList'),
          href: '/transfer/list',
        },
      ].sort((a, b) => normalizeForSort(a.title).localeCompare(normalizeForSort(b.title), 'tr')),
    },
    {
      title: t('sidebar.subcontracting', 'Fason İşlemleri'),
      icon: (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
        </svg>
      ),
      children: [
        {
          title: t('sidebar.subcontractingIssueAssigned', 'Atanmış Fason Çıkış Emirleri'),
          href: '/subcontracting/issue/assigned',
        },
        {
          title: t('sidebar.subcontractingIssueApproval', 'Onay Bekleyen Fason Çıkış Emirleri'),
          href: '/subcontracting/issue/approval',
        },
        {
          title: t('sidebar.subcontractingIssueCreate', 'Fason Çıkış Emri'),
          href: '/subcontracting/issue/create',
        },
        {
          title: t('sidebar.subcontractingIssueList', 'Fason Çıkış Listesi'),
          href: '/subcontracting/issue/list',
        },
        {
          title: t('sidebar.subcontractingReceiptAssigned', 'Atanmış Fason Giriş Emirleri'),
          href: '/subcontracting/receipt/assigned',
        },
        {
          title: t('sidebar.subcontractingReceiptApproval', 'Onay Bekleyen Fason Giriş Emirleri'),
          href: '/subcontracting/receipt/approval',
        },
        {
          title: t('sidebar.subcontractingReceiptCreate', 'Fason Giriş Emri'),
          href: '/subcontracting/receipt/create',
        },
        {
          title: t('sidebar.subcontractingReceiptList', 'Fason Giriş Listesi'),
          href: '/subcontracting/receipt/list',
        },
      ].sort((a, b) => normalizeForSort(a.title).localeCompare(normalizeForSort(b.title), 'tr')),
    },
    {
      title: t('sidebar.warehouse', 'Ambar İşlemleri'),
      icon: (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <path d="M22 8.35V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8.35l8 2.8 8-2.8z" />
          <path d="M6 18h12" />
          <path d="M6 14h12" />
          <path d="M22 8.35l-10-3.57L2 8.35" />
        </svg>
      ),
      children: [
        {
          title: t('sidebar.warehouseInboundAssigned', 'Atanmış Ambar Giriş Emirleri'),
          href: '/warehouse/inbound/assigned',
        },
        {
          title: t('sidebar.warehouseInboundApproval', 'Onay Bekleyen Ambar Giriş Emirleri'),
          href: '/warehouse/inbound/approval',
        },
        {
          title: t('sidebar.warehouseInboundCreate', 'Ambar Giriş Emri'),
          href: '/warehouse/inbound/create',
        },
        {
          title: t('sidebar.warehouseInboundList', 'Ambar Giriş Listesi'),
          href: '/warehouse/inbound/list',
        },
        {
          title: t('sidebar.warehouseOutboundAssigned', 'Atanmış Ambar Çıkış Emirleri'),
          href: '/warehouse/outbound/assigned',
        },
        {
          title: t('sidebar.warehouseOutboundApproval', 'Onay Bekleyen Ambar Çıkış Emirleri'),
          href: '/warehouse/outbound/approval',
        },
        {
          title: t('sidebar.warehouseOutboundCreate', 'Ambar Çıkış Emri'),
          href: '/warehouse/outbound/create',
        },
        {
          title: t('sidebar.warehouseOutboundList', 'Ambar Çıkış Listesi'),
          href: '/warehouse/outbound/list',
        },
      ].sort((a, b) => normalizeForSort(a.title).localeCompare(normalizeForSort(b.title), 'tr')),
    },
    {
      title: t('sidebar.shipment', 'Sevkiyat'),
      icon: (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <path d="M5 18H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h3.19M5 18l6-6M5 18v-5a2 2 0 0 1 2-2h5" />
          <path d="m13 6 4 4-4 4" />
          <path d="M17 10h5" />
        </svg>
      ),
      children: [
        {
          title: t('sidebar.shipmentAssigned', 'Atanmış Sevkiyat Emirleri'),
          href: '/shipment/assigned',
        },
        {
          title: t('sidebar.shipmentApproval', 'Onay Bekleyen Sevkiyat Emirleri'),
          href: '/shipment/approval',
        },
        {
          title: t('sidebar.shipmentCreate', 'Sevkiyat Emri'),
          href: '/shipment/create',
        },
        {
          title: t('sidebar.shipmentList', 'Sevkiyat Emri Listesi'),
          href: '/shipment/list',
        },
      ].sort((a, b) => normalizeForSort(a.title).localeCompare(normalizeForSort(b.title), 'tr')),
    },
    {
      title: t('sidebar.parameters', 'Parametre'),
      icon: (
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth="2"
          strokeLinecap="round"
          strokeLinejoin="round"
        >
          <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
        </svg>
      ),
      children: [
        {
          title: t('sidebar.parametersGr', 'Mal Kabul Parametreleri'),
          href: '/parameters/gr',
        },
        {
          title: t('sidebar.parametersWt', 'Depo Transfer Parametreleri'),
          href: '/parameters/wt',
        },
        {
          title: t('sidebar.parametersWo', 'Depo Çıkış Parametreleri'),
          href: '/parameters/wo',
        },
        {
          title: t('sidebar.parametersWi', 'Depo Giriş Parametreleri'),
          href: '/parameters/wi',
        },
        {
          title: t('sidebar.parametersSh', 'Sevkiyat Parametreleri'),
          href: '/parameters/sh',
        },
        {
          title: t('sidebar.parametersSrt', 'Taşeron Alış Transfer Parametreleri'),
          href: '/parameters/srt',
        },
        {
          title: t('sidebar.parametersSit', 'Taşeron Çıkış Transfer Parametreleri'),
          href: '/parameters/sit',
        },
        {
          title: t('sidebar.parametersPt', 'Üretim Transfer Parametreleri'),
          href: '/parameters/pt',
        },
        {
          title: t('sidebar.parametersPr', 'Üretim Parametreleri'),
          href: '/parameters/pr',
        },
        {
          title: t('sidebar.parametersIc', 'Sayım Parametreleri'),
          href: '/parameters/ic',
        },
        {
          title: t('sidebar.parametersP', 'Paket Parametreleri'),
          href: '/parameters/p',
        },
      ].sort((a, b) => normalizeForSort(a.title).localeCompare(normalizeForSort(b.title), 'tr')),
    },
  ], [t]);

  const sortedNavItems = useMemo(() => {
    const dashboard = defaultNavItems.find((item) => item.href === '/');
    const others = defaultNavItems.filter((item) => item.href !== '/');
    
    const sortedOthers = [...others].sort((a, b) => 
      normalizeForSort(a.title).localeCompare(normalizeForSort(b.title), 'tr')
    );
    
    return dashboard ? [dashboard, ...sortedOthers] : sortedOthers;
  }, [defaultNavItems]);

  const items = navItems || sortedNavItems;
  const { isSidebarOpen } = useUIStore();

  return (
    <div className="flex h-screen flex-col overflow-hidden">
      <Navbar />
      <div className="flex flex-1 overflow-hidden">
        <Sidebar items={items} />
        <main
          className={cn(
            'flex-1 overflow-y-auto transition-all duration-300 pb-16',
            isSidebarOpen ? 'lg:ml-64' : 'lg:ml-16',
          )}
        >
          <div className="container px-4 py-3">
            <Outlet />
          </div>
        </main>
      </div>
      <Footer />
    </div>
  );
}
